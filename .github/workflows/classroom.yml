name: Autograding Tests
on:
  - push
  - workflow_dispatch
  - repository_dispatch
permissions:
  checks: write
  actions: read
  contents: read
jobs:
  run-autograding-tests:
    runs-on: ubuntu-latest
    if: github.actor != 'github-classroom[bot]'
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Pre-compilar Release
      run: dotnet build -c Release

    # Caso 1: Valor M치ximo Est치ndar
    - name: Valor Maximo Estandar
      id: valor-maximo-estandar
      uses: classroom-resources/autograding-io-grader@v1
      with:
        test-name: "Valor Maximo Estandar"
        command: "/usr/bin/time -v ./bin/Release/net10.0/TestArreglo > out1.txt 2> met1.txt && cat out1.txt"
        input: "5\n10 20 5 8 15"
        expected-output: "20"
        comparison-method: contains
        timeout: 10
        max-score: 40

    # Caso 2: M치ximo con Negativos
    - name: Maximo con Negativos
      id: maximo-con-negativos
      uses: classroom-resources/autograding-io-grader@v1
      with:
        test-name: "Maximo con Negativos"
        command: "/usr/bin/time -v ./bin/Release/net10.0/TestArreglo > out2.txt 2> met2.txt && cat out2.txt"
        input: "3\n-10 -5 -30"
        expected-output: "-5"
        comparison-method: contains
        timeout: 10
        max-score: 30

    # Caso 3: Elemento 칔nico
    - name: Arreglo de un elemento
      id: arreglo-un-elemento
      uses: classroom-resources/autograding-io-grader@v1
      with:
        test-name: "Arreglo de un elemento"
        command: "/usr/bin/time -v ./bin/Release/net10.0/TestArreglo > out3.txt 2> met3.txt && cat out3.txt"
        input: "1\n99"
        expected-output: "99"
        comparison-method: contains
        timeout: 10
        max-score: 30

    # REPORTE FINAL UNIFICADO CON C츼LCULO AUTOM츼TICO
    - name: 游늵 REPORTE DE EFICIENCIA Y L칍GICA
      if: always()
      run: |
        echo "==============================================================="
        echo "   AUDITOR칈A T칄CNICA DE ALGORITMOS - UMG PROGRA III"
        echo "==============================================================="
        
        # Extraer valores para el c치lculo (Caso 1)
        TIME_VAL=$(grep "User time" met1.txt | cut -d: -f2 | xargs || echo "0")
        RAM_VAL=$(grep "Maximum resident set size" met1.txt | cut -d: -f2 | xargs || echo "0")
        
        # Calcular Score Ol칤mpico usando AWK
        SCORE=$(awk -v t="$TIME_VAL" -v r="$RAM_VAL" 'BEGIN { printf "%.2f", (t * 1000) + (r / 1024) }')

        echo "1. PRUEBA: VALOR M츼XIMO EST츼NDAR"
        echo "   游닌 Entrada: [10, 20, 5, 8, 15] | 游꿢 Esperado: 20"
        echo -n "   游닋 Resultado del Alumno: " && cat out1.txt
        grep -E "User time|Maximum resident set size|Percent of CPU" met1.txt | sed 's/\t//g'
        echo "---------------------------------------------------------------"

        echo "2. PRUEBA: M츼XIMO CON NEGATIVOS"
        echo "   游닌 Entrada: [-10, -5, -30] | 游꿢 Esperado: -5"
        echo -n "   游닋 Resultado del Alumno: " && cat out2.txt
        grep -E "User time|Maximum resident set size|Percent of CPU" met2.txt | sed 's/\t//g'
        echo "---------------------------------------------------------------"

        echo "3. PRUEBA: ELEMENTO 칔NICO"
        echo "   游닌 Entrada: [99] | 游꿢 Esperado: 99"
        echo -n "   游닋 Resultado del Alumno: " && cat out3.txt
        grep -E "User time|Maximum resident set size|Percent of CPU" met3.txt | sed 's/\t//g'
        
        echo ""
        echo "游끥 RESULTADO FINAL PARA EL RANKING:"
        echo ">>>> SCORE OL칈MPICO: $SCORE <<<<"
        echo "---------------------------------------------------------------"
        echo "F칩rmula aplicada: ($TIME_VAL x 1000) + ($RAM_VAL / 1024)"
        echo "Recuerda: Menor Score = Mayor Eficiencia."
        echo "==============================================================="

    - name: Autograding Reporter
      uses: classroom-resources/autograding-grading-reporter@v1
      env:
        VALOR-MAXIMO-ESTANDAR_RESULTS: "${{ steps.valor-maximo-estandar.outputs.result }}"
        MAXIMO-CON-NEGATIVOS_RESULTS: "${{ steps.maximo-con-negativos.outputs.result }}"
        ARREGLO-UN-ELEMENTO_RESULTS: "${{ steps.arreglo-un-elemento.outputs.result }}"
      with:
        runners: valor-maximo-estandar,maximo-con-negativos,arreglo-un-elemento
